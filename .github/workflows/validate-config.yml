name: ğŸ” Validate Configuration

on:
  workflow_dispatch:
  schedule:
    # Ejecutar validaciÃ³n semanal los lunes a las 9 AM
    - cron: '0 9 * * 1'

jobs:
  validate-config:
    name: ğŸ” Validate Project Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ” Validate package.json
        run: |
          echo "ğŸ” Validating package.json structure..."
          node -e "
            const pkg = require('./package.json');
            const requiredScripts = [
              'dev', 'build', 'preview', 'lint', 'lint:fix', 
              'test', 'test:ci', 'test:coverage', 'type-check',
              'format', 'format:check', 'build:analyze', 'clean'
            ];
            
            const missingScripts = requiredScripts.filter(script => !pkg.scripts[script]);
            
            if (missingScripts.length > 0) {
              console.error('âŒ Missing required scripts:', missingScripts);
              process.exit(1);
            }
            
            console.log('âœ… All required scripts are present');
          "

      - name: ğŸ” Validate TypeScript configuration
        run: |
          echo "ğŸ” Validating TypeScript configuration..."
          npx tsc --noEmit --skipLibCheck

      - name: ğŸ” Validate ESLint configuration
        run: |
          echo "ğŸ” Validating ESLint configuration..."
          npm run lint -- --max-warnings 0

      - name: ğŸ” Validate Prettier configuration
        run: |
          echo "ğŸ” Validating Prettier configuration..."
          npm run format:check

      - name: ğŸ” Validate environment variables
        run: |
          echo "ğŸ” Validating environment variables..."
          node -e "
            const fs = require('fs');
            
            // Verificar que .env.example existe
            if (!fs.existsSync('.env.example')) {
              console.error('âŒ .env.example file is missing');
              process.exit(1);
            }
            
            // Leer variables requeridas
            const envExample = fs.readFileSync('.env.example', 'utf8');
            const requiredVars = [
              'VITE_FIREBASE_API_KEY',
              'VITE_FIREBASE_AUTH_DOMAIN',
              'VITE_FIREBASE_PROJECT_ID',
              'VITE_FIREBASE_STORAGE_BUCKET',
              'VITE_FIREBASE_MESSAGING_SENDER_ID',
              'VITE_FIREBASE_APP_ID'
            ];
            
            const missingVars = requiredVars.filter(varName => !envExample.includes(varName));
            
            if (missingVars.length > 0) {
              console.error('âŒ Missing required environment variables in .env.example:', missingVars);
              process.exit(1);
            }
            
            console.log('âœ… All required environment variables are documented');
          "

      - name: ğŸ” Validate GitHub workflows
        run: |
          echo "ğŸ” Validating GitHub workflows..."
          
          # Verificar que los workflows principales existen
          workflows=(
            ".github/workflows/ci.yml"
            ".github/workflows/cd.yml"
            ".github/workflows/security.yml"
            ".github/workflows/pr-checks.yml"
          )
          
          for workflow in "${workflows[@]}"; do
            if [ ! -f "$workflow" ]; then
              echo "âŒ Missing workflow: $workflow"
              exit 1
            else
              echo "âœ… Found workflow: $workflow"
            fi
          done

      - name: ğŸ” Validate Dependabot configuration
        run: |
          echo "ğŸ” Validating Dependabot configuration..."
          
          if [ ! -f ".github/dependabot.yml" ]; then
            echo "âŒ Missing .github/dependabot.yml"
            exit 1
          fi
          
          # Validar sintaxis YAML
          python -c "
          import yaml
          import sys
          
          try:
              with open('.github/dependabot.yml', 'r') as f:
                  yaml.safe_load(f)
              print('âœ… Dependabot configuration is valid YAML')
          except yaml.YAMLError as e:
              print(f'âŒ Invalid YAML in dependabot.yml: {e}')
              sys.exit(1)
          "

      - name: ğŸ” Validate build output
        run: |
          echo "ğŸ” Validating build process..."
          npm run build
          
          # Verificar que los archivos de build se generaron
          if [ ! -d "dist" ]; then
            echo "âŒ Build directory 'dist' was not created"
            exit 1
          fi
          
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ index.html was not generated in build"
            exit 1
          fi
          
          echo "âœ… Build process completed successfully"

      - name: ğŸ” Validate test configuration
        run: |
          echo "ğŸ” Validating test configuration..."
          
          # Ejecutar tests sin coverage para validar configuraciÃ³n
          npm run test:run
          
          echo "âœ… Test configuration is valid"

      - name: ğŸ” Check for security vulnerabilities
        run: |
          echo "ğŸ” Checking for security vulnerabilities..."
          npm audit --audit-level=high
          echo "âœ… No high-severity vulnerabilities found"

      - name: ğŸ” Validate bundle size
        run: |
          echo "ğŸ” Validating bundle size..."
          npm run build:analyze
          
          # Verificar que el bundle no sea demasiado grande (ejemplo: 2MB)
          BUNDLE_SIZE=$(du -sb dist | cut -f1)
          MAX_SIZE=2097152  # 2MB en bytes
          
          if [ $BUNDLE_SIZE -gt $MAX_SIZE ]; then
            echo "âš ï¸ Bundle size ($BUNDLE_SIZE bytes) exceeds recommended maximum ($MAX_SIZE bytes)"
            echo "Consider optimizing your bundle size"
          else
            echo "âœ… Bundle size is within acceptable limits"
          fi

      - name: ğŸ“Š Generate validation report
        if: always()
        run: |
          echo "ğŸ“Š Configuration Validation Report"
          echo "=================================="
          echo "Date: $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "âœ… Configuration validation completed"
          echo ""
          echo "ğŸ“‹ Next steps if validation failed:"
          echo "1. Review the failed checks above"
          echo "2. Fix any configuration issues"
          echo "3. Run the validation locally: npm run test:ci"
          echo "4. Commit and push your fixes"

  notify-results:
    name: ğŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: validate-config
    if: always() && github.event_name == 'schedule'
    
    steps:
      - name: ğŸ“¢ Notify validation results
        run: |
          if [ "${{ needs.validate-config.result }}" == "success" ]; then
            echo "âœ… Weekly configuration validation passed"
          else
            echo "âŒ Weekly configuration validation failed"
            echo "Please check the workflow logs and fix any issues"
          fi